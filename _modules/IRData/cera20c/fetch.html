
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>IRData.cera20c.fetch &#8212; An API for accessing synoptic-timescale reanalyis data</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">IRData</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/UK.GS1987.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../subdata/data_20CR.html">The 20th Century Reanalysis: IRData.twcr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subdata/data_cera20c.html">The CERA-20C reanalysis: IRData.cera20c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subdata/data_era5.html">The ERA-5 reanalysis: IRData.era5</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Authors and acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uses.html">Uses of this package</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/IRData">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/IRData"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/IRData/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for IRData.cera20c.fetch</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) British Crown Copyright 2017, Met Office</span>
<span class="c1">#</span>
<span class="c1"># This code is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the</span>
<span class="c1"># Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This code is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>

<span class="c1"># Functions to fetch CERA data through the ECMWF Public data API</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">ecmwfapi</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">_hourly_get_file_name</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">_translate_for_file_names</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">monolevel_analysis</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">monolevel_forecast</span>

<div class="viewcode-block" id="fetch"><a class="viewcode-back" href="../../../subdata/data_cera20c.html#IRData.cera20c.fetch">[docs]</a><span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">dtime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get all data for one variable, for one month, from ECMWF&#39;s archive.</span>

<span class="sd">    Data wil be stored locally in directory $SCRATCH/CERA-20C, to be retrieved by :func:`load`. If the local file that would be produced already exists, this function does nothing.</span>

<span class="sd">    Args:</span>
<span class="sd">        variable (:obj:`str`): Variable to fetch (e.g. &#39;prmsl&#39;)</span>
<span class="sd">        dtime (:obj:`datetime.datetime`): Date-time to fetch the data for.</span>
<span class="sd">        month (:obj:`int`): Month to get data for (1-12).</span>

<span class="sd">    Will retrieve the data for the year and month of the given date-time. If the selected time is within 6-hours of the end of the calendar month, loading data for that time will also need data from the next calendar month (for interpolation). In this case, also fetch the data for the next calendar month. </span>

<span class="sd">    Raises:</span>
<span class="sd">        StandardError: If Variable is not a supported value.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ndtime</span><span class="o">=</span><span class="n">dtime</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndtime</span><span class="o">.</span><span class="n">month</span><span class="o">!=</span><span class="n">dtime</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
        <span class="n">fetch</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">ndtime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">monolevel_analysis</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_fetch_analysis_data_for_month</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span>
                                      <span class="n">dtime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">dtime</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">monolevel_forecast</span><span class="p">:</span>
        <span class="k">return</span>  <span class="n">_fetch_forecast_data_for_month</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span>
                                      <span class="n">dtime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">dtime</span><span class="o">.</span><span class="n">month</span><span class="p">)</span></div>
    <span class="k">raise</span> <span class="n">StandardError</span><span class="p">(</span><span class="s2">&quot;Unsupported variable </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">variable</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_fetch_analysis_data_for_month</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">):</span>
        
    <span class="n">local_file</span><span class="o">=</span><span class="n">_hourly_get_file_name</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
        <span class="c1"># Got this data already</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">))</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">ecmwfapi</span><span class="o">.</span><span class="n">ECMWFDataServer</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">retrieve</span><span class="p">({</span>
        <span class="s1">&#39;dataset&#39;</span>   <span class="p">:</span> <span class="s1">&#39;cera20c&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stream&#39;</span>    <span class="p">:</span> <span class="s1">&#39;enda&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span>      <span class="p">:</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span>
        <span class="s1">&#39;class&#39;</span>     <span class="p">:</span> <span class="s1">&#39;ep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expver&#39;</span>    <span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;levtype&#39;</span>   <span class="p">:</span> <span class="s1">&#39;sfc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;param&#39;</span>     <span class="p">:</span> <span class="n">_translate_for_file_names</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span>
        <span class="s1">&#39;time&#39;</span>      <span class="p">:</span> <span class="s1">&#39;00/03/06/09/12/15/18/21&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid&#39;</span>      <span class="p">:</span> <span class="s1">&#39;1.25/1.25&#39;</span><span class="p">,</span>
        <span class="s1">&#39;number&#39;</span>    <span class="p">:</span> <span class="s1">&#39;0/1/2/3/4/5/6/7/8/9&#39;</span><span class="p">,</span>
        <span class="s1">&#39;date&#39;</span>      <span class="p">:</span> <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">/to/</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span>
                        <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;format&#39;</span>    <span class="p">:</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;target&#39;</span>    <span class="p">:</span> <span class="n">local_file</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">_fetch_forecast_data_for_month</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">):</span>
        
    <span class="c1"># Want 27 hours of forecast for each day</span>
    <span class="c1">#         (so we can interpolate over the seam),</span>
    <span class="c1">#  but the 27-hr forcast from one day has the same</span>
    <span class="c1">#      validity time as the 3-hr forecast from the</span>
    <span class="c1">#       next day - so need to download them separately</span>
    <span class="c1">#       and store in different files.</span>

    <span class="c1"># First 24-hours of forecast in main file</span>
    <span class="n">local_file</span><span class="o">=</span><span class="n">_hourly_get_file_name</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span>
                                    <span class="n">fc_init</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
        <span class="c1"># Got this data already</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">))</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">ecmwfapi</span><span class="o">.</span><span class="n">ECMWFDataServer</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">retrieve</span><span class="p">({</span>
        <span class="s1">&#39;dataset&#39;</span>   <span class="p">:</span> <span class="s1">&#39;cera20c&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stream&#39;</span>    <span class="p">:</span> <span class="s1">&#39;enda&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span>      <span class="p">:</span> <span class="s1">&#39;fc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;class&#39;</span>     <span class="p">:</span> <span class="s1">&#39;ep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expver&#39;</span>    <span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;levtype&#39;</span>   <span class="p">:</span> <span class="s1">&#39;sfc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;param&#39;</span>     <span class="p">:</span> <span class="n">_translate_for_file_names</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span>
        <span class="s1">&#39;time&#39;</span>      <span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span>
        <span class="s1">&#39;step&#39;</span>      <span class="p">:</span> <span class="s1">&#39;3/6/9/12/15/18/21/24&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid&#39;</span>      <span class="p">:</span> <span class="s1">&#39;1.25/1.25&#39;</span><span class="p">,</span>
        <span class="s1">&#39;number&#39;</span>    <span class="p">:</span> <span class="s1">&#39;0/1/2/3/4/5/6/7/8/9&#39;</span><span class="p">,</span>
        <span class="s1">&#39;date&#39;</span>      <span class="p">:</span> <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">/to/</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span>
                        <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;format&#39;</span>    <span class="p">:</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;target&#39;</span>    <span class="p">:</span> <span class="n">local_file</span>
    <span class="p">})</span>


    <span class="c1"># 27-hour forecast in additional file</span>
    <span class="n">local_file</span><span class="o">=</span><span class="n">_hourly_get_file_name</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span>
                                     <span class="n">fc_init</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
        <span class="c1"># Got this data already</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">))</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">ecmwfapi</span><span class="o">.</span><span class="n">ECMWFDataServer</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">retrieve</span><span class="p">({</span>
        <span class="s1">&#39;dataset&#39;</span>   <span class="p">:</span> <span class="s1">&#39;cera20c&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stream&#39;</span>    <span class="p">:</span> <span class="s1">&#39;enda&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span>      <span class="p">:</span> <span class="s1">&#39;fc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;class&#39;</span>     <span class="p">:</span> <span class="s1">&#39;ep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expver&#39;</span>    <span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;levtype&#39;</span>   <span class="p">:</span> <span class="s1">&#39;sfc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;param&#39;</span>     <span class="p">:</span> <span class="n">_translate_for_file_names</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span>
        <span class="s1">&#39;time&#39;</span>      <span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span>
        <span class="s1">&#39;step&#39;</span>      <span class="p">:</span> <span class="s1">&#39;27&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid&#39;</span>      <span class="p">:</span> <span class="s1">&#39;1.25/1.25&#39;</span><span class="p">,</span>
        <span class="s1">&#39;number&#39;</span>    <span class="p">:</span> <span class="s1">&#39;0/1/2/3/4/5/6/7/8/9&#39;</span><span class="p">,</span>
        <span class="s1">&#39;date&#39;</span>      <span class="p">:</span> <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">/to/</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span>
                        <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;format&#39;</span>    <span class="p">:</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;target&#39;</span>    <span class="p">:</span> <span class="n">local_file</span>
    <span class="p">})</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">IRData</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>